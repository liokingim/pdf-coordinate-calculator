<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF ì¢Œí‘œ ê³„ì‚°ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        #pdf-container {
            overflow: auto;
            max-height: 80vh;
            border: 2px dashed #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background-color: #f3f4f6;
            cursor: crosshair;
            position: relative;
        }

        canvas {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        // PDF.js ì›Œì»¤ ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>

<body class="bg-gray-100 h-screen overflow-hidden flex flex-col">

    <!-- í—¤ë” -->
    <header class="bg-white shadow-sm p-4 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                PDF ì¢Œí‘œ ì¶”ì¶œê¸°
            </h1>
            <div class="flex items-center gap-4">
                <span id="page-info" class="text-sm text-gray-500 hidden">í˜ì´ì§€ <span id="page-num">0</span> / <span
                        id="page-count">0</span></span>
                <label
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow cursor-pointer transition">
                    <span>ğŸ“‚ PDF ì—´ê¸°</span>
                    <input type="file" id="file-input" accept="application/pdf" class="hidden" />
                </label>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="flex-1 flex overflow-hidden">

        <!-- ì™¼ìª½: PDF ë·°ì–´ ì˜ì—­ -->
        <div class="flex-1 flex flex-col border-r border-gray-200 bg-gray-50 relative">
            <!-- íˆ´ë°” -->
            <div class="h-12 bg-white border-b border-gray-200 flex items-center justify-between px-4">
                <div class="flex gap-2">
                    <button id="prev-page" class="p-1 rounded hover:bg-gray-100 disabled:opacity-50" disabled
                        title="ì´ì „ í˜ì´ì§€">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                clip-rule="evenodd" /></button>
                    <button id="next-page" class="p-1 rounded hover:bg-gray-100 disabled:opacity-50" disabled
                        title="ë‹¤ìŒ í˜ì´ì§€">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd" /></button>
                </div>
                <div class="text-sm text-gray-600 font-medium" id="status-msg">íŒŒì¼ì„ ì—´ì–´ì£¼ì„¸ìš”</div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-gray-500">í™•ëŒ€:</span>
                    <select id="scale-select" class="text-sm border border-gray-300 rounded p-1">
                        <option value="0.75">75%</option>
                        <option value="1.0" selected>100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                        <option value="2.0">200%</option>
                    </select>
                </div>
            </div>

            <!-- ìº”ë²„ìŠ¤ ì˜ì—­ -->
            <div id="pdf-container" class="flex-1 p-8 relative">
                <div class="loader" id="loader"></div>
                <canvas id="the-canvas" class="hidden"></canvas>
                <!-- ì¢Œí‘œ í´ë¦­ í‘œì‹œ ë§ˆì»¤ (ì‹œê°ì  íš¨ê³¼) -->
                <div id="click-marker"
                    class="absolute w-3 h-3 bg-red-500 rounded-full pointer-events-none transform -translate-x-1/2 -translate-y-1/2 hidden border border-white shadow-sm z-50">
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì„¤ì • ë° ë°ì´í„° ì˜ì—­ -->
        <div class="w-80 bg-white shadow-xl flex flex-col z-20">
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <h2 class="font-bold text-gray-700 mb-2">ì„¤ì • ì…ë ¥</h2>
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">í°íŠ¸ í¬ê¸° (Font Size)</label>
                        <input type="number" id="font-size" value="12"
                            class="w-full border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            placeholder="ì˜ˆ: 12">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">ì¢Œí‘œ í˜•ì‹ (ë¯¸ë¦¬ë³´ê¸°)</label>
                        <div class="text-xs text-gray-400 bg-gray-100 p-2 rounded">
                            x: 100, y: 200, size: 12
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="invert-y" class="rounded text-blue-600">
                        <label for="invert-y" class="text-xs text-gray-600 cursor-pointer select-none">Yì¶• ë°˜ì „ (ì¢Œì¸¡ í•˜ë‹¨ì´
                            0,0)</label>
                    </div>
                </div>
            </div>

            <div class="flex-1 p-4 flex flex-col min-h-0">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-gray-700">ì¶”ì¶œëœ ì¢Œí‘œ</h2>
                    <button id="clear-btn" class="text-xs text-red-500 hover:text-red-700 underline">ë¹„ìš°ê¸°</button>
                </div>
                <textarea id="coords-output"
                    class="flex-1 w-full border border-gray-300 rounded p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none bg-gray-50"
                    placeholder="PDFë¥¼ í´ë¦­í•˜ë©´ ì—¬ê¸°ì— ì¢Œí‘œê°€ ì¶”ê°€ë©ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤."></textarea>
            </div>

            <div class="p-4 border-t border-gray-200">
                <button id="copy-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow transition flex justify-center items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    í´ë¦½ë³´ë“œì— ë³µì‚¬ (ì €ì¥)
                </button>
            </div>
        </div>
    </main>

    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast"
        class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded shadow-lg transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <script>
        let pdfDoc = null;
        let pageNum = 1;
        let pageRendering = false;
        let pageNumPending = null;
        let scale = 1.0;
        let canvas = document.getElementById('the-canvas');
        let ctx = canvas.getContext('2d');

        const loader = document.getElementById('loader');
        const statusMsg = document.getElementById('status-msg');
        const fileInput = document.getElementById('file-input');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const scaleSelect = document.getElementById('scale-select');
        const coordsOutput = document.getElementById('coords-output');
        const copyBtn = document.getElementById('copy-btn');
        const clearBtn = document.getElementById('clear-btn');
        const clickMarker = document.getElementById('click-marker');
        const invertYCheckbox = document.getElementById('invert-y');

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const fileReader = new FileReader();
                loader.style.display = 'block';
                canvas.classList.add('hidden');
                statusMsg.textContent = "PDF ë¡œë”© ì¤‘...";

                fileReader.onload = function () {
                    const typedarray = new Uint8Array(this.result);

                    pdfjsLib.getDocument(typedarray).promise.then(function (pdfDoc_) {
                        pdfDoc = pdfDoc_;
                        document.getElementById('page-count').textContent = pdfDoc.numPages;
                        document.getElementById('page-info').classList.remove('hidden');

                        pageNum = 1;
                        renderPage(pageNum);
                        updateButtons();
                    }).catch(function (error) {
                        console.error('Error loading PDF:', error);
                        statusMsg.textContent = "PDFë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
                        loader.style.display = 'none';
                        alert('PDF íŒŒì¼ì´ ì†ìƒë˜ì—ˆê±°ë‚˜ ì•”í˜¸í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        // í˜ì´ì§€ ë Œë”ë§
        function renderPage(num) {
            pageRendering = true;

            // ê¸°ì¡´ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
            pdfDoc.getPage(num).then(function (page) {
                const viewport = page.getViewport({ scale: scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆì— ë§ì¶° ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ ì¡°ì • ë“±ì„ ìœ„í•´ ìŠ¤íƒ€ì¼ ì„¤ì •
                canvas.style.width = `${viewport.width}px`;
                canvas.style.height = `${viewport.height}px`;

                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                const renderTask = page.render(renderContext);

                // ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°
                renderTask.promise.then(function () {
                    pageRendering = false;
                    loader.style.display = 'none';
                    canvas.classList.remove('hidden');
                    statusMsg.textContent = `${num} í˜ì´ì§€ (${Math.round(viewport.width)} x ${Math.round(viewport.height)})`;

                    document.getElementById('page-num').textContent = num;

                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
        }

        // í˜ì´ì§€ ëŒ€ê¸°ì—´ ì²˜ë¦¬
        function queueRenderPage(num) {
            if (pageRendering) {
                pageNumPending = num;
            } else {
                renderPage(num);
            }
        }

        // ì´ì „ í˜ì´ì§€
        function onPrevPage() {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
            updateButtons();
        }

        // ë‹¤ìŒ í˜ì´ì§€
        function onNextPage() {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
            updateButtons();
        }

        function updateButtons() {
            prevButton.disabled = pageNum <= 1;
            nextButton.disabled = pageNum >= pdfDoc.numPages;
        }

        // ì¤Œ ë³€ê²½
        scaleSelect.addEventListener('change', function () {
            scale = parseFloat(this.value);
            if (pdfDoc) queueRenderPage(pageNum);
        });

        prevButton.addEventListener('click', onPrevPage);
        nextButton.addEventListener('click', onNextPage);

        // ì¢Œí‘œ í´ë¦­ ì´ë²¤íŠ¸ (í•µì‹¬ ë¡œì§)
        canvas.addEventListener('mousedown', function (e) {
            if (!pdfDoc) return;

            const rect = canvas.getBoundingClientRect();

            // ìº”ë²„ìŠ¤ ë‚´ë¶€ì—ì„œì˜ í´ë¦­ ìœ„ì¹˜ ê³„ì‚° (0 ~ Canvas Size)
            let x = e.clientX - rect.left;
            let y = e.clientY - rect.top;

            // 1. í˜„ì¬ í™”ë©´ ë°°ìœ¨(Scale) ë³´ì •: PDF ì›ë³¸ í¬ì¸íŠ¸ ë‹¨ìœ„(1/72 inch)ë¡œ ë³€í™˜
            // PDF.jsëŠ” ê¸°ë³¸ì ìœ¼ë¡œ 72 DPIì…ë‹ˆë‹¤.
            let pdfX = x / scale;
            let pdfY = y / scale;

            // 2. Yì¶• ë°˜ì „ ì˜µì…˜ (PDF í‘œì¤€ ì¢Œí‘œê³„: ì¢Œì¸¡ í•˜ë‹¨ì´ 0,0)
            if (invertYCheckbox.checked) {
                // í˜„ì¬ ìº”ë²„ìŠ¤ì˜ ì›ë³¸(scale=1) ë†’ì´ë¥¼ êµ¬í•´ì•¼ í•¨
                const rawHeight = canvas.height / scale;
                pdfY = rawHeight - pdfY;
            }

            // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
            pdfX = Math.round(pdfX * 100) / 100;
            pdfY = Math.round(pdfY * 100) / 100;

            const fontSize = document.getElementById('font-size').value || '0';

            // í…ìŠ¤íŠ¸ ì—ì–´ë¦¬ì–´ì— ì¶”ê°€
            const newEntry = `x: ${pdfX}, y: ${pdfY}, size: ${fontSize}`;

            if (coordsOutput.value.trim() === "") {
                coordsOutput.value = newEntry;
            } else {
                coordsOutput.value += "\n" + newEntry;
            }

            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            coordsOutput.scrollTop = coordsOutput.scrollHeight;

            // ì‹œê°ì  ë§ˆì»¤ í‘œì‹œ (ìº”ë²„ìŠ¤ ì ˆëŒ€ ì¢Œí‘œ ê¸°ì¤€)
            // e.clientX, e.clientYëŠ” ë·°í¬íŠ¸ ê¸°ì¤€ì´ë¯€ë¡œ, ì»¨í…Œì´ë„ˆ ê¸°ì¤€ ìƒëŒ€ì¢Œí‘œë¥¼ ì‚¬ìš©í•´ì•¼ ìŠ¤í¬ë¡¤ ì‹œì—ë„ ì •í™•í•¨
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í´ë¦­ ì§€ì ì— ë§ˆì»¤ë¥¼ ì°ê¸° ìœ„í•´ ë¶€ëª¨ ì»¨í…Œì´ë„ˆ(relative) ê¸°ì¤€ ìœ„ì¹˜ ê³„ì‚°
            const containerRect = document.getElementById('pdf-container').getBoundingClientRect();
            const markerX = e.clientX - containerRect.left + document.getElementById('pdf-container').scrollLeft;
            const markerY = e.clientY - containerRect.top + document.getElementById('pdf-container').scrollTop;

            clickMarker.style.left = `${markerX}px`;
            clickMarker.style.top = `${markerY}px`;
            clickMarker.classList.remove('hidden');

            // ë§ˆì»¤ ê¹œë¹¡ì„ íš¨ê³¼
            clickMarker.style.transform = "translate(-50%, -50%) scale(1.5)";
            setTimeout(() => {
                clickMarker.style.transform = "translate(-50%, -50%) scale(1)";
            }, 150);
        });

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        copyBtn.addEventListener('click', function () {
            const text = coordsOutput.value;
            if (!text) return;

            // textarea ì„ íƒ ë° ë³µì‚¬ (êµ¬í˜• ë¸Œë¼ìš°ì € í˜¸í™˜ ë° ìµœì‹  API ë³‘í–‰)
            coordsOutput.select();

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(showToast).catch(err => {
                    // ì‹¤íŒ¨ì‹œ fallback
                    document.execCommand('copy');
                    showToast();
                });
            } else {
                document.execCommand('copy');
                showToast();
            }
        });

        // ë¹„ìš°ê¸° ë²„íŠ¼
        clearBtn.addEventListener('click', () => {
            if (confirm('ëª¨ë“  ì¢Œí‘œ ê¸°ë¡ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                coordsOutput.value = '';
                clickMarker.classList.add('hidden');
            }
        });

        function showToast() {
            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        }

        // ì´ˆê¸° ìƒíƒœ
        updateButtons();
    </script>
</body>

</html>